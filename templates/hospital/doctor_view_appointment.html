{% extends 'hospital/doctor_base.html' %}
{% load static %}
{% block content %}

<div class="container">
  <div class="panel panel-primary">
    <div class="panel-heading">
      <h3 style="text-align: center; color: white; margin: 10px 0;">MIS CITAS</h3>
    </div>
    
    <div class="panel-body">
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}

      {% if appointment_data %}
      <table class="table table-striped" style="width: 100%;">
        <thead>
          <tr>
            <th>Paciente</th>
            <th>Descripci√≥n</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th>Receta</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for data in appointment_data %}
          <tr>
            <td><strong>{{ data.patient.get_name }}</strong></td>
            <td>{{ data.appointment.description }}</td>
            <td>{{ data.appointment.appointmentDate }}</td>
            <td>
              <!-- Mostrar estado CORREGIDO para manejar True como pendiente -->
              {% if data.appointment.status == 'pending' or data.appointment.status == True %}
                <span style="background: orange; color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px;">
                  PENDIENTE
                </span>
              {% elif data.appointment.status == 'done' %}
                <span style="background: green; color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px;">
                  ATENDIDO
                </span>
              {% elif data.appointment.status == 'cancelled' %}
                <span style="background: red; color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px;">
                  CANCELADO
                </span>
              {% else %}
                <span style="background: gray; color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px;">
                  {{ data.appointment.status }}
                </span>
              {% endif %}
            </td>
            <td>
              <!-- NUEVO: Estado de Receta -->
              {% if data.appointment.status == 'done' %}
                {% if data.has_prescription %}
                <span style="background: #1a237e; color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px;">
                  <i class="fa fa-check-circle"></i> RECETA HECHA
                </span>
                {% else %}
                <span style="background: #ff6f00; color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px;">
                  <i class="fa fa-file-text"></i> SIN RECETA
                </span>
                {% endif %}
              {% else %}
                <span style="background: #9e9e9e; color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px;">
                  N/A
                </span>
              {% endif %}
            </td>
            <td>
              <!-- MEN√ö DESPLEGABLE - CORREGIDO para manejar True -->
              <div class="dropdown">
                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-toggle="dropdown" 
                        style="background: #007bff; border: none; padding: 6px 12px;">
                  Acciones <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                  
                  <!-- Si est√° pendiente o tiene status=True -->
                  {% if data.appointment.status == 'pending' or data.appointment.status == True %}
                    <li>
                      <a href="{% url 'update-appointment-status' data.appointment.id 'done' %}" 
                         onclick="return confirm('¬øMarcar cita de {{ data.patient.get_name }} como ATENDIDA?')"
                         style="color: green; padding: 8px 15px; display: block; text-decoration: none;">
                        <i class="fa fa-check"></i> Marcar como Atendido
                      </a>
                    </li>
                    <li>
                      <a href="{% url 'update-appointment-status' data.appointment.id 'cancelled' %}" 
                         onclick="return confirm('¬øCancelar cita de {{ data.patient.get_name }}?')"
                         style="color: red; padding: 8px 15px; display: block; text-decoration: none;">
                        <i class="fa fa-times"></i> Cancelar Cita
                      </a>
                    </li>
                  {% elif data.appointment.status == 'done' %}
                    <!-- SOLO CUANDO EST√Å ATENDIDO Y NO TIENE RECETA MOSTRAR OPCI√ìN DE CREAR RECETA -->
                    {% if not data.has_prescription %}
                    <li>
                      <a href="{% url 'doctor-create-prescription' %}?appointment_id={{ data.appointment.id }}&patient_id={{ data.patient.id }}" 
                         style="color: #1a237e; padding: 8px 15px; display: block; text-decoration: none; background-color: #e3f2fd; font-weight: bold;">
                        <i class="fa fa-file-text"></i> <strong>Crear Receta M√©dica</strong>
                      </a>
                    </li>
                    <li role="separator" class="divider"></li>
                    {% else %}
                    <li>
                      <a href="#" 
                         style="color: #1a237e; padding: 8px 15px; display: block; text-decoration: none; background-color: #e8f5e8;">
                        <i class="fa fa-check-circle"></i> <strong>Receta Ya Creada</strong>
                      </a>
                    </li>
                    <li role="separator" class="divider"></li>
                    {% endif %}
                    
                    <li>
                      <a href="{% url 'update-appointment-status' data.appointment.id 'pending' %}" 
                         onclick="return confirm('¬øVolver a marcar como PENDIENTE?')"
                         style="color: orange; padding: 8px 15px; display: block; text-decoration: none;">
                        <i class="fa fa-clock-o"></i> Volver a Pendiente
                      </a>
                    </li>
                  {% elif data.appointment.status == 'cancelled' %}
                    <li>
                      <a href="{% url 'update-appointment-status' data.appointment.id 'pending' %}" 
                         onclick="return confirm('¬øReactivar cita de {{ data.patient.get_name }}?')"
                         style="color: blue; padding: 8px 15px; display: block; text-decoration: none;">
                        <i class="fa fa-refresh"></i> Reactivar Cita
                      </a>
                    </li>
                  {% else %}
                    <!-- Para cualquier otro estado desconocido, mostrar opciones b√°sicas -->
                    <li>
                      <a href="{% url 'update-appointment-status' data.appointment.id 'done' %}" 
                         onclick="return confirm('¬øMarcar como ATENDIDO?')"
                         style="color: green; padding: 8px 15px; display: block; text-decoration: none;">
                        <i class="fa fa-check"></i> Marcar como Atendido
                      </a>
                    </li>
                    <li>
                      <a href="{% url 'update-appointment-status' data.appointment.id 'pending' %}" 
                         onclick="return confirm('¬øMarcar como PENDIENTE?')"
                         style="color: orange; padding: 8px 15px; display: block; text-decoration: none;">
                        <i class="fa fa-clock-o"></i> Marcar como Pendiente
                      </a>
                    </li>
                  {% endif %}
                  
                  <!-- Opci√≥n para ver detalles -->
                  <li role="separator" class="divider"></li>
                  <li>
                    <a href="#" 
                       onclick="showAppointmentDetails('{{ data.patient.get_name }}', '{{ data.appointment.doctorName }}', '{{ data.appointment.appointmentDate }}', '{% if data.appointment.status == True %}PENDIENTE{% else %}{{ data.appointment.status }}{% endif %}', '{{ data.appointment.description }}', '{% if data.has_prescription %}S√ç{% else %}NO{% endif %}')"
                       style="color: #333; padding: 8px 15px; display: block; text-decoration: none;">
                      <i class="fa fa-eye"></i> Ver Detalles
                    </a>
                  </li>
                  
                </ul>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-center" style="padding: 20px; font-size: 16px;">No tienes citas asignadas</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Incluir Bootstrap JS para el dropdown -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

<style>
.dropdown-menu {
  min-width: 240px;
  border-radius: 5px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  border: 1px solid #ddd;
}

.dropdown-menu li a:hover {
  background-color: #f5f5f5;
}

.dropdown-toggle {
  border-radius: 4px;
}

.divider {
  height: 1px;
  margin: 5px 0;
  overflow: hidden;
  background-color: #e5e5e5;
}

/* Estilo especial para la opci√≥n de receta m√©dica */
.dropdown-menu li a[href*="doctor-create-prescription"] {
  font-weight: bold;
  border-left: 3px solid #1a237e;
}

.dropdown-menu li a[href*="doctor-create-prescription"]:hover {
  background-color: #1a237e !important;
  color: white !important;
}

/* Estilo para receta ya creada */
.dropdown-menu li a[style*="background-color: #e8f5e8"] {
  border-left: 3px solid #4caf50;
  cursor: default;
}

.dropdown-menu li a[style*="background-color: #e8f5e8"]:hover {
  background-color: #e8f5e8 !important;
  color: #1a237e !important;
}

/* Mejora visual para la tabla */
.table-striped tbody tr:nth-of-type(odd) {
  background-color: rgba(0, 123, 255, 0.05);
}

.table th {
  background-color: #343a40;
  color: white;
  border: none;
}
</style>

<script>
// Auto-cerrar mensajes despu√©s de 3 segundos
setTimeout(function(){
    var alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
        alert.style.display = 'none';
    });
}, 3000);

// Funci√≥n mejorada para mostrar detalles de la cita
function showAppointmentDetails(patientName, doctorName, appointmentDate, status, description, hasPrescription) {
    let prescriptionStatus = 'NO';
    let prescriptionColor = '#ff6f00';
    
    if (hasPrescription === 'S√ç') {
        prescriptionStatus = 'S√ç';
        prescriptionColor = '#1a237e';
    }
    
    const details = `
üìã <strong>DETALLES DE LA CITA</strong>

üë§ <strong>Paciente:</strong> ${patientName}
üë®‚Äç‚öïÔ∏è <strong>Doctor:</strong> ${doctorName}
üìÖ <strong>Fecha:</strong> ${appointmentDate}
üìä <strong>Estado:</strong> ${status}
üìù <strong>Descripci√≥n:</strong> ${description}
üíä <strong>Receta M√©dica:</strong> <span style="color: ${prescriptionColor}; font-weight: bold;">${prescriptionStatus}</span>

${hasPrescription === 'S√ç' ? 
'‚úÖ Esta cita ya tiene una receta m√©dica asociada.' : 
'üìã Esta cita est√° lista para crear una receta m√©dica.'}
    `;
    
    alert(details);
}

// Mostrar tooltip informativo
$(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();
});

// Prevenir clic en "Receta Ya Creada"
document.addEventListener('click', function(e) {
    if (e.target.closest('a') && e.target.closest('a').style.backgroundColor === 'rgb(232, 245, 232)') {
        e.preventDefault();
        alert('‚ÑπÔ∏è Esta cita ya tiene una receta m√©dica creada.\n\nPuede ver la receta en el m√≥dulo de "Recetas M√©dicas".');
    }
});
</script>

{% endblock %}