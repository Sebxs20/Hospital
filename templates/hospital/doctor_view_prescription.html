{% extends 'hospital/doctor_base.html' %}
{% load static %}

{% block content %}
<br><br><br>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header" style="background-color: #1a237e; color: white;">
                    <h4 class="text-center">
                        <i class="fa fa-file-text"></i> Mis Recetas M√©dicas
                    </h4>
                    <p class="text-center mb-0">Historial de recetas creadas</p>
                </div>
                <div class="card-body">

                    <!-- Mensajes -->
                    {% if messages %}
                    {% for message in messages %}
                    <div
                        class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    </div>
                    {% endfor %}
                    {% endif %}

                    <!-- Botones de acci√≥n -->
                    <div class="mb-4">
                        <a href="{% url 'doctor-create-prescription' %}" class="btn btn-success">
                            <i class="fa fa-plus"></i> Crear Nueva Receta
                        </a>
                        <a href="{% url 'doctor-prescription' %}" class="btn btn-secondary">
                            <i class="fa fa-arrow-left"></i> Volver al Dashboard
                        </a>

                        <!-- Filtros -->
                        <div class="btn-group float-right">
                            <button type="button" class="btn btn-outline-primary dropdown-toggle"
                                data-toggle="dropdown">
                                <i class="fa fa-filter"></i> Filtrar por Estado
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="?status=all">Todos</a>
                                <a class="dropdown-item" href="?status=pendiente">Pendientes</a>
                                <a class="dropdown-item" href="?status=liquidado">Liquidadas</a>
                                <a class="dropdown-item" href="?status=completada">Completadas</a>
                                <a class="dropdown-item" href="?status=cancelada">Canceladas</a>
                            </div>
                        </div>
                    </div>

                    <!-- Estad√≠sticas r√°pidas -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-white bg-primary">
                                <div class="card-body text-center">
                                    <h6>Total Recetas</h6>
                                    <h3>{{ prescriptions.count }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-warning">
                                <div class="card-body text-center">
                                    <h6>Pendientes</h6>
                                    <h3>{{ pending_count|default:0 }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-success">
                                <div class="card-body text-center">
                                    <h6>Liquidadas</h6>
                                    <h3>{{ liquidated_count|default:0 }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-info">
                                <div class="card-body text-center">
                                    <h6>Este Mes</h6>
                                    <h3>{{ monthly_count|default:0 }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de recetas -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID Receta</th>
                                    <th>Paciente</th>
                                    <th>Diagn√≥stico</th>
                                    <th>Medicamentos</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prescription in prescriptions %}
                                <tr>
                                    <td>
                                        <strong>#{{ prescription.id }}</strong>
                                        <br>
                                        <small class="text-muted">{{ prescription.created_at|date:"d/m/Y" }}</small>
                                    </td>
                                    <td>
                                        <strong>{{ prescription.patient.get_name }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            <i class="fa fa-phone"></i> {{ prescription.patient.mobile }}
                                        </small>
                                        <br>
                                        <small class="text-muted">
                                            {{ prescription.patient.symptoms|truncatewords:5 }}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="diagnosis-text">
                                            {{ prescription.diagnosis|truncatewords:10 }}
                                        </div>
                                        {% if prescription.diagnosis|wordcount > 10 %}
                                        <button type="button" class="btn btn-sm btn-link p-0"
                                            onclick="showFullText('diagnosis-{{ prescription.id }}')">
                                            <small>Ver m√°s</small>
                                        </button>
                                        <div id="diagnosis-{{ prescription.id }}" style="display: none;">
                                            {{ prescription.diagnosis }}
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="medicines-list">
                                            {% for medicine in prescription.medicines.all %}
                                            <div class="mb-1">
                                                <span class="badge badge-info">{{ medicine.medicine.name }}</span>
                                                <br>
                                                <small>
                                                    <strong>Cant:</strong> {{ medicine.quantity }} |
                                                    <strong>Dosis:</strong> {{ medicine.dosage|truncatewords:3 }}
                                                </small>
                                            </div>
                                            {% if not forloop.last %}
                                            <hr class="my-1">{% endif %}
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        <small>
                                            <strong>Creada:</strong> {{ prescription.created_at|date:"d/m/Y" }}
                                            <br>
                                            <strong>Hora:</strong> {{ prescription.created_at|time:"H:i" }}
                                            {% if prescription.updated_at != prescription.created_at %}
                                            <br>
                                            <strong>Actualizada:</strong> {{ prescription.updated_at|date:"d/m/Y" }}
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical btn-group-sm">
                                            <button type="button" class="btn btn-info"
                                                onclick="showPrescriptionDetails({{ prescription.id }})"
                                                title="Ver detalles completos">
                                                <i class="fa fa-eye"></i> Ver
                                            </button>
                                            <button type="button" class="btn btn-secondary"
                                                onclick="printPrescription({{ prescription.id }})"
                                                title="Imprimir receta">
                                                <i class="fa fa-print"></i> PDF
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="alert alert-info py-4">
                                            <i class="fa fa-info-circle fa-2x mb-3"></i>
                                            <h5>No hay recetas m√©dicas registradas</h5>
                                            <p class="mb-0">Comienza creando tu primera receta m√©dica</p>
                                            <a href="{% url 'doctor-create-prescription' %}"
                                                class="btn btn-primary mt-2">
                                                <i class="fa fa-plus"></i> Crear Primera Receta
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginaci√≥n (si es necesaria en el futuro) -->
                    {% if prescriptions.has_other_pages %}
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if prescriptions.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ prescriptions.previous_page_number }}">Anterior</a>
                            </li>
                            {% endif %}

                            {% for i in prescriptions.paginator.page_range %}
                            <li class="page-item {% if prescriptions.number == i %}active{% endif %}">
                                <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                            </li>
                            {% endfor %}

                            {% if prescriptions.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ prescriptions.next_page_number }}">Siguiente</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalles de receta -->
<div class="modal fade" id="prescriptionModal" tabindex="-1" role="dialog" aria-labelledby="prescriptionModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="prescriptionModalLabel">
                    <i class="fa fa-file-text"></i> Detalles de Receta M√©dica
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="prescriptionDetails">
                <!-- Los detalles se cargar√°n aqu√≠ din√°micamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="printModalContent()">
                    <i class="fa fa-print"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .badge-lg {
        padding: 8px 12px;
        font-size: 12px;
    }

    .diagnosis-text {
        max-height: 60px;
        overflow: hidden;
    }

    .medicines-list {
        max-height: 120px;
        overflow-y: auto;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(26, 35, 126, 0.05);
    }

    .btn-group-vertical .btn {
        margin-bottom: 2px;
        text-align: left;
    }

    /* Scroll personalizado */
    .medicines-list::-webkit-scrollbar {
        width: 4px;
    }

    .medicines-list::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .medicines-list::-webkit-scrollbar-thumb {
        background: #1a237e;
        border-radius: 2px;
    }

    .medicines-list::-webkit-scrollbar-thumb:hover {
        background: #3949ab;
    }

    /* Estilos para estado liquidado */
    .badge-success {
        background-color: #28a745 !important;
    }
</style>

<script>
    // Funci√≥n para mostrar detalles completos de la receta
    function showPrescriptionDetails(prescriptionId) {
        // En una implementaci√≥n real, aqu√≠ har√≠as una petici√≥n AJAX para obtener los detalles
        const details = `
        <div class="prescription-details">
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fa fa-user"></i> Informaci√≥n del Paciente</h6>
                    <p><strong>Nombre:</strong> Lupita Arenas</p>
                    <p><strong>ID:</strong> 517672 NA</p>
                    <p><strong>Tel√©fono:</strong> 555-0123</p>
                </div>
                <div class="col-md-6">
                    <h6><i class="fa fa-info-circle"></i> Informaci√≥n de la Receta</h6>
                    <p><strong>ID Receta:</strong> #${prescriptionId}</p>
                    <p><strong>Fecha:</strong> 23/11/2025</p>
                    <p><strong>Estado:</strong> <span class="badge badge-success">LIQUIDADO</span></p>
                </div>
            </div>
            <hr>
            <h6><i class="fa fa-stethoscope"></i> Diagn√≥stico</h6>
            <p>Diagn√≥stico m√©dico completo del paciente seg√∫n la evaluaci√≥n realizada.</p>
            
            <h6><i class="fa fa-medkit"></i> Medicamentos Recetados</h6>
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Medicamento</th>
                            <th>Cantidad</th>
                            <th>Dosis</th>
                            <th>Duraci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Paracetamol</td>
                            <td>1</td>
                            <td>1 tableta cada 8 horas</td>
                            <td>5 d√≠as</td>
                        </tr>
                        <tr>
                            <td>Ibuprofeno</td>
                            <td>1</td>
                            <td>1 tableta cada 12 horas</td>
                            <td>3 d√≠as</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="alert alert-success mt-3">
                <i class="fa fa-check-circle"></i> 
                <strong>Receta Liquidada:</strong> El paciente ha realizado el pago correspondiente.
            </div>
        </div>
    `;

        document.getElementById('prescriptionDetails').innerHTML = details;
        $('#prescriptionModal').modal('show');
    }

    // Funci√≥n para editar receta (solo pendientes no pagadas)
    function editPrescription(prescriptionId) {
        if (confirm('¬øDesea editar esta receta m√©dica?')) {
            // Redirigir a la p√°gina de edici√≥n
            window.location.href = `/doctor-edit-prescription/${prescriptionId}/`;
        }
    }

    // Funci√≥n para imprimir receta
    function printPrescription(prescriptionId) {
        if (confirm('¬øGenerar PDF de esta receta m√©dica?')) {
            // En una implementaci√≥n real, aqu√≠ generar√≠as el PDF
            alert(`üìÑ Generando PDF para receta #${prescriptionId}`);
            // window.location.href = `/doctor-print-prescription/${prescriptionId}/`;
        }
    }

    // Funci√≥n para mostrar texto completo
    function showFullText(elementId) {
        const element = document.getElementById(elementId);
        if (element.style.display === 'none') {
            element.style.display = 'block';
            event.target.innerHTML = '<small>Ver menos</small>';
        } else {
            element.style.display = 'none';
            event.target.innerHTML = '<small>Ver m√°s</small>';
        }
    }

    // Funci√≥n para imprimir contenido del modal
    function printModalContent() {
        const printContent = document.getElementById('prescriptionDetails').innerHTML;
        const originalContent = document.body.innerHTML;

        document.body.innerHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Receta M√©dica - HOSPITAL LUJASE</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                .section { margin-bottom: 20px; }
                .medicine-item { background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px; }
                .badge { padding: 5px 10px; border-radius: 3px; color: white; }
                .badge-success { background-color: #28a745; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f8f9fa; }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>HOSPITAL LUJASE</h2>
                <h3>Receta M√©dica</h3>
            </div>
            ${printContent}
        </body>
        </html>
    `;

        window.print();
        document.body.innerHTML = originalContent;
        location.reload();
    }

    // Auto-cerrar mensajes despu√©s de 5 segundos
    setTimeout(function () {
        $('.alert').alert('close');
    }, 5000);

    // Inicializar tooltips
    $(document).ready(function () {
        $('[title]').tooltip();
    });
</script>
{% endblock %}